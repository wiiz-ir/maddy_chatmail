<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, minimum-scale=1.0">
    <title>{{.MailDomain}} account deletion</title>
    <link rel="stylesheet" href="./main.css">
    <link rel="icon" href="/logo.svg">
    <link rel="mask-icon" href="/logo.svg" color="#000000">
</head>
<body>

<ul id="menu">
    <li><a href="index.html">home</a></li>
    <li><a href="info.html">info</a></li>
    <li><a href="privacy.html">privacy</a></li>
    {{if .AllowCustom}}<li><a href="custom.html">custom</a></li>{{end}}
    <li><a href="password-change.html">password</a></li>
    <li><a href="account-deletion.html">delete account</a></li>
    <li><a href="https://github.com/deltachat/chatmail">public code ↗</a></li>
    <li id="domain"><a href="index.html">{{.MailDomain}}</a></li>
</ul>

<h2>Delete Account</h2>
<p>Permanently delete your {{.MailDomain}} account and all associated data.</p>

<div class="warning-box">
    <h3>⚠️ Warning: This action cannot be undone!</h3>
    <ul>
        <li>Your account and all messages will be permanently deleted</li>
        <li>You will lose access to all your chat history</li>
        <li>This cannot be reversed once confirmed</li>
        <li>You will need your current password to proceed</li>
    </ul>
</div>

<form id="accountDeletionForm">
    <div class="form-group">
        <label for="email">Email Address:</label>
        <input type="email" id="email" name="email" required 
               placeholder="your-email@{{.MailDomain}}">
        <small>Enter your {{.MailDomain}} email address to delete</small>
    </div>
    
    <div class="form-group">
        <label for="password">Password:</label>
        <input type="password" id="password" name="password" required 
               placeholder="Enter your current password">
        <small>Your password is required to confirm account deletion</small>
    </div>
    
    <div class="form-group">
        <label for="confirmDeletion">
            <input type="checkbox" id="confirmDeletion" name="confirmDeletion" required>
            I understand that this action is permanent and cannot be undone
        </label>
    </div>
    
    <div class="form-group">
        <label for="confirmText">Type "DELETE" to confirm:</label>
        <input type="text" id="confirmText" name="confirmText" required 
               placeholder="Type DELETE in capital letters">
    </div>
    
    <button type="submit" class="danger-button">Delete My Account Permanently</button>
</form>

<div id="result" style="display: none;">
    <h3>Account Deletion Initiated</h3>
    <p>Your account deletion request has been processed.</p>
    <p>Your {{.MailDomain}} account and all associated data has been permanently removed.</p>
    
    <div class="action-buttons">
        <button type="button" id="backToHome" class="primary-button">Back to Home</button>
    </div>
</div>

<div id="error" style="display: none; color: red;">
    <h3>Error</h3>
    <p id="errorMessage"></p>
</div>

<style>
.warning-box {
    background-color: #f8d7da;
    border: 1px solid #f5c6cb;
    border-radius: 4px;
    padding: 1rem;
    margin-bottom: 2rem;
}

.warning-box h3 {
    margin-top: 0;
    color: #721c24;
}

.warning-box ul {
    margin-bottom: 0;
}

.warning-box li {
    margin-bottom: 0.5rem;
}

.form-group {
    margin-bottom: 1rem;
}

.form-group label {
    display: block;
    margin-bottom: 0.5rem;
    font-weight: bold;
}

.form-group input[type="email"],
.form-group input[type="password"],
.form-group input[type="text"] {
    width: 100%;
    max-width: 300px;
    padding: 0.5rem;
    border: 1px solid #ccc;
    border-radius: 4px;
    font-size: 1rem;
}

.form-group input[type="checkbox"] {
    margin-right: 0.5rem;
}

.form-group small {
    display: block;
    margin-top: 0.25rem;
    color: #666;
}

button {
    background-color: #007bff;
    color: white;
    padding: 0.75rem 1.5rem;
    border: none;
    border-radius: 4px;
    font-size: 1rem;
    cursor: pointer;
}

button:hover {
    background-color: #0056b3;
}

button:disabled {
    background-color: #ccc;
    cursor: not-allowed;
}

.danger-button {
    background-color: #dc3545;
    font-weight: bold;
}

.danger-button:hover {
    background-color: #c82333;
}

.action-buttons {
    display: flex;
    flex-direction: column;
    gap: 0.5rem;
    margin-top: 1rem;
}

.primary-button {
    background-color: #28a745;
    font-weight: bold;
}

.primary-button:hover {
    background-color: #218838;
}
</style>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const form = document.getElementById('accountDeletionForm');
    const emailInput = document.getElementById('email');
    const passwordInput = document.getElementById('password');
    const confirmDeletionCheckbox = document.getElementById('confirmDeletion');
    const confirmTextInput = document.getElementById('confirmText');
    const resultDiv = document.getElementById('result');
    const errorDiv = document.getElementById('error');
    
    // Form submission
    form.addEventListener('submit', function(e) {
        e.preventDefault();
        
        const email = emailInput.value.trim();
        const password = passwordInput.value;
        const confirmDeletion = confirmDeletionCheckbox.checked;
        const confirmText = confirmTextInput.value.trim();
        
        // Hide previous results
        resultDiv.style.display = 'none';
        errorDiv.style.display = 'none';
        
        // Validate inputs
        if (!email || !password) {
            showError('Email and password are required.');
            return;
        }
        
        if (!email.endsWith('@{{.MailDomain}}')) {
            showError('Email must be a {{.MailDomain}} address.');
            return;
        }
        
        if (!confirmDeletion) {
            showError('You must confirm that you understand this action is permanent.');
            return;
        }
        
        if (confirmText !== 'DELETE') {
            showError('You must type "DELETE" exactly as shown to confirm.');
            return;
        }
        
        // Double confirmation
        const finalConfirm = confirm(
            `Are you absolutely sure you want to permanently delete your account ${email}?\n\n` +
            `This action CANNOT be undone and will:\n` +
            `- Delete all your messages and data\n` +
            `- Remove your account permanently\n` +
            `- Cannot be reversed\n\n` +
            `Click OK to proceed with deletion, or Cancel to go back.`
        );
        
        if (!finalConfirm) {
            return;
        }
        
        // Submit to server
        const submitButton = form.querySelector('button[type="submit"]');
        submitButton.disabled = true;
        submitButton.textContent = 'Deleting Account...';
        
        fetch('/account-deletion', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                email: email,
                password: password,
                confirm: 'DELETE'
            })
        })
        .then(response => {
            if (!response.ok) {
                return response.text().then(text => {
                    throw new Error(text || 'Failed to delete account');
                });
            }
            return response.json();
        })
        .then(data => {
            resultDiv.style.display = 'block';
            form.style.display = 'none';
            setupActionButtons();
        })
        .catch(error => {
            showError(error.message);
        })
        .finally(() => {
            submitButton.disabled = false;
            submitButton.textContent = 'Delete My Account Permanently';
        });
    });
    
    function showError(message) {
        document.getElementById('errorMessage').textContent = message;
        errorDiv.style.display = 'block';
    }
    
    function setupActionButtons() {
        const backToHomeBtn = document.getElementById('backToHome');
        
        backToHomeBtn.addEventListener('click', function() {
            window.location.href = 'index.html';
        });
    }
});
</script>

</body>
</html>
