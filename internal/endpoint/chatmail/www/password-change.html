<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, minimum-scale=1.0">
    <title>{{.MailDomain}} password change</title>
    <link rel="stylesheet" href="./main.css">
    <link rel="icon" href="/logo.svg">
    <link rel="mask-icon" href="/logo.svg" color="#000000">
</head>
<body>

<ul id="menu">
    <li><a href="index.html">home</a></li>
    <li><a href="info.html">info</a></li>
    <li><a href="privacy.html">privacy</a></li>
    {{if .AllowCustom}}<li><a href="custom.html">custom</a></li>{{end}}
    <li><a href="password-change.html">password</a></li>
    <li><a href="account-deletion.html">delete account</a></li>
    <li><a href="https://github.com/deltachat/chatmail">public code ↗</a></li>
    <li id="domain"><a href="index.html">{{.MailDomain}}</a></li>
</ul>

<h2>Change Password</h2>
<p>Change the password for your {{.MailDomain}} account.</p>

<div class="info-box">
    <h3>⚠️ Important Notes:</h3>
    <ul>
        <li><strong>Save your password safely</strong> - you'll need it for account deletion</li>
        <li><strong>For multiple devices:</strong> Don't manually add this account to other devices. Instead, use the "Add Second Device" feature in Delta Chat to properly sync encryption keys</li>
        <li>Manual login on multiple devices will prevent proper key synchronization</li>
    </ul>
</div>

<form id="passwordChangeForm">
    <div class="form-group">
        <label for="email">Email Address:</label>
        <input type="email" id="email" name="email" required 
               placeholder="your-email@{{.MailDomain}}">
        <small>Enter your current {{.MailDomain}} email address</small>
    </div>
    
    <div class="form-group">
        <label for="currentPassword">Current Password:</label>
        <input type="password" id="currentPassword" name="currentPassword" required 
               placeholder="Enter your current password">
    </div>
    
    <div class="form-group">
        <label for="newPassword">New Password:</label>
        <div class="password-input-group">
            <input type="password" id="newPassword" name="newPassword" required 
                   placeholder="Enter new password (min 8 characters)">
            <button type="button" id="generatePassword" class="secondary-button">Generate Random</button>
        </div>
        <div class="password-strength" id="passwordStrength"></div>
    </div>
    
    <div class="form-group">
        <label for="confirmNewPassword">Confirm New Password:</label>
        <input type="password" id="confirmNewPassword" name="confirmNewPassword" required 
               placeholder="Confirm your new password">
    </div>
    
    <button type="submit">Change Password</button>
</form>

<div id="result" style="display: none;">
    <h3>Password Changed Successfully!</h3>
    <p>Your password has been updated. Please save your new password securely.</p>
    <p><strong>New Password:</strong> <span id="resultPassword"></span></p>
    
    <div class="action-buttons">
        <button type="button" id="copyNewPassword" class="secondary-button">Copy Password</button>
        <button type="button" id="backToLogin" class="primary-button">Back to Home</button>
    </div>
</div>

<div id="error" style="display: none; color: red;">
    <h3>Error</h3>
    <p id="errorMessage"></p>
</div>

<style>
.info-box {
    background-color: #fff3cd;
    border: 1px solid #ffeaa7;
    border-radius: 4px;
    padding: 1rem;
    margin-bottom: 2rem;
}

.info-box h3 {
    margin-top: 0;
    color: #856404;
}

.info-box ul {
    margin-bottom: 0;
}

.info-box li {
    margin-bottom: 0.5rem;
}

.form-group {
    margin-bottom: 1rem;
}

.form-group label {
    display: block;
    margin-bottom: 0.5rem;
    font-weight: bold;
}

.form-group input {
    width: 100%;
    max-width: 300px;
    padding: 0.5rem;
    border: 1px solid #ccc;
    border-radius: 4px;
    font-size: 1rem;
}

.form-group small {
    display: block;
    margin-top: 0.25rem;
    color: #666;
}

.password-input-group {
    display: flex;
    gap: 0.5rem;
    align-items: center;
}

.password-input-group input {
    flex: 1;
}

.password-strength {
    margin-top: 0.25rem;
    font-size: 0.9rem;
    font-weight: bold;
}

.password-strength.weak {
    color: #dc3545;
}

.password-strength.medium {
    color: #ffc107;
}

.password-strength.strong {
    color: #28a745;
}

button {
    background-color: #007bff;
    color: white;
    padding: 0.75rem 1.5rem;
    border: none;
    border-radius: 4px;
    font-size: 1rem;
    cursor: pointer;
}

button:hover {
    background-color: #0056b3;
}

button:disabled {
    background-color: #ccc;
    cursor: not-allowed;
}

.action-buttons {
    display: flex;
    flex-direction: column;
    gap: 0.5rem;
    margin-top: 1rem;
}

.primary-button {
    background-color: #28a745;
    font-weight: bold;
}

.primary-button:hover {
    background-color: #218838;
}

.secondary-button {
    background-color: #6c757d;
}

.secondary-button:hover {
    background-color: #545b62;
}
</style>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const form = document.getElementById('passwordChangeForm');
    const emailInput = document.getElementById('email');
    const currentPasswordInput = document.getElementById('currentPassword');
    const newPasswordInput = document.getElementById('newPassword');
    const confirmNewPasswordInput = document.getElementById('confirmNewPassword');
    const generatePasswordBtn = document.getElementById('generatePassword');
    const passwordStrength = document.getElementById('passwordStrength');
    const resultDiv = document.getElementById('result');
    const errorDiv = document.getElementById('error');
    
    // Password strength checker
    newPasswordInput.addEventListener('input', function() {
        checkPasswordStrength(this.value);
    });
    
    // Generate random password
    generatePasswordBtn.addEventListener('click', function() {
        const randomPassword = generateRandomPassword(16);
        newPasswordInput.value = randomPassword;
        confirmNewPasswordInput.value = randomPassword;
        checkPasswordStrength(randomPassword);
    });
    
    // Form submission
    form.addEventListener('submit', function(e) {
        e.preventDefault();
        
        const email = emailInput.value.trim();
        const currentPassword = currentPasswordInput.value;
        const newPassword = newPasswordInput.value;
        const confirmNewPassword = confirmNewPasswordInput.value;
        
        // Hide previous results
        resultDiv.style.display = 'none';
        errorDiv.style.display = 'none';
        
        // Validate inputs
        if (!email || !currentPassword || !newPassword || !confirmNewPassword) {
            showError('All fields are required.');
            return;
        }
        
        if (!email.endsWith('@{{.MailDomain}}')) {
            showError('Email must be a {{.MailDomain}} address.');
            return;
        }
        
        if (newPassword !== confirmNewPassword) {
            showError('New passwords do not match.');
            return;
        }
        
        if (newPassword.length < 8) {
            showError('New password must be at least 8 characters long.');
            return;
        }
        
        if (newPassword === currentPassword) {
            showError('New password must be different from current password.');
            return;
        }
        
        // Submit to server
        const submitButton = form.querySelector('button[type="submit"]');
        submitButton.disabled = true;
        submitButton.textContent = 'Changing...';
        
        fetch('/password-change', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                email: email,
                current_password: currentPassword,
                new_password: newPassword
            })
        })
        .then(response => {
            if (!response.ok) {
                return response.text().then(text => {
                    throw new Error(text || 'Failed to change password');
                });
            }
            return response.json();
        })
        .then(data => {
            document.getElementById('resultPassword').textContent = newPassword;
            resultDiv.style.display = 'block';
            form.style.display = 'none';
            setupActionButtons(newPassword);
        })
        .catch(error => {
            showError(error.message);
        })
        .finally(() => {
            submitButton.disabled = false;
            submitButton.textContent = 'Change Password';
        });
    });
    
    function checkPasswordStrength(password) {
        if (password.length === 0) {
            passwordStrength.textContent = '';
            passwordStrength.className = 'password-strength';
            return;
        }
        
        let strength = 0;
        if (password.length >= 8) strength++;
        if (password.length >= 12) strength++;
        if (/[A-Z]/.test(password)) strength++;
        if (/[a-z]/.test(password)) strength++;
        if (/[0-9]/.test(password)) strength++;
        if (/[^A-Za-z0-9]/.test(password)) strength++;
        
        if (strength <= 2) {
            passwordStrength.textContent = 'Weak';
            passwordStrength.className = 'password-strength weak';
        } else if (strength <= 4) {
            passwordStrength.textContent = 'Medium';
            passwordStrength.className = 'password-strength medium';
        } else {
            passwordStrength.textContent = 'Strong';
            passwordStrength.className = 'password-strength strong';
        }
    }
    
    function generateRandomPassword(length) {
        const charset = "ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789!@#$%^&*()_+-=[]{}|;:,.<>?";
        let password = "";
        for (let i = 0; i < length; i++) {
            password += charset.charAt(Math.floor(Math.random() * charset.length));
        }
        return password;
    }
    
    function showError(message) {
        document.getElementById('errorMessage').textContent = message;
        errorDiv.style.display = 'block';
    }
    
    async function copyToClipboard(text) {
        try {
            await navigator.clipboard.writeText(text);
            alert('Password copied to clipboard!');
        } catch (err) {
            console.error('Failed to copy: ', err);
            alert('Failed to copy password to clipboard');
        }
    }
    
    function setupActionButtons(password) {
        const copyPasswordBtn = document.getElementById('copyNewPassword');
        const backToLoginBtn = document.getElementById('backToLogin');
        
        copyPasswordBtn.addEventListener('click', function() {
            copyToClipboard(password);
        });
        
        backToLoginBtn.addEventListener('click', function() {
            window.location.href = 'index.html';
        });
    }
});
</script>

</body>
</html>
